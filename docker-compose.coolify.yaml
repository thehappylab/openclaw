services:
  openclaw:
    image: 'ghcr.io/thehappylab/openclaw:5572e58'
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENCLAW_PRIMARY_MODEL=${PRIMARY_MODEL}
      - GH_TOKEN=${GH_TOKEN}
      - BW_CLIENTID=${BW_CLIENTID}
      - BW_CLIENTSECRET=${BW_CLIENTSECRET}
      - BW_SERVER=${BW_SERVER}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - OPENCLAW_PREINSTALL_CLAWS=${OPENCLAW_PREINSTALL_CLAWS}
      - COOLIFY_API_TOKEN=${COOLIFY_API_TOKEN}

      - SERVICE_FQDN_OPENCLAW_8080
      - AUTH_USERNAME=$SERVICE_USER_OPENCLAW
      - AUTH_PASSWORD=$SERVICE_PASSWORD_OPENCLAW
      - OPENCLAW_GATEWAY_TOKEN=$SERVICE_PASSWORD_64_GATEWAYTOKEN
      - PORT=8080
      - OPENCLAW_GATEWAY_PORT=18789
      - 'OPENCLAW_GATEWAY_BIND=${OPENCLAW_GATEWAY_BIND:-loopback}'
      - OPENCLAW_STATE_DIR=/data/.openclaw
      - OPENCLAW_WORKSPACE_DIR=/data/workspace
      - 'BROWSER_CDP_URL=http://browser:9223'
      - 'BROWSER_DEFAULT_PROFILE=${BROWSER_DEFAULT_PROFILE:-openclaw}'
      - 'BROWSER_EVALUATE_ENABLED=${BROWSER_EVALUATE_ENABLED:-true}'
      - 'BROWSER_SNAPSHOT_MODE=${BROWSER_SNAPSHOT_MODE:-efficient}'
      - 'BROWSER_REMOTE_TIMEOUT_MS=${BROWSER_REMOTE_TIMEOUT_MS:-1500}'
      - 'BROWSER_REMOTE_HANDSHAKE_TIMEOUT_MS=${BROWSER_REMOTE_HANDSHAKE_TIMEOUT_MS:-3000}'
      - 'HOOKS_ENABLED=${HOOKS_ENABLED:-false}'
      - 'HOOKS_PATH=${HOOKS_PATH:-/hooks}'
      - DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN
      - OPENCLAW_DOCKER_APT_PACKAGES=$OPENCLAW_DOCKER_APT_PACKAGES
    volumes:
      - 'openclaw-data:/data'
    depends_on:
      browser:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - curl
        - '-sf'
        - 'http://127.0.0.1:8080/healthz'
      interval: 10s
      timeout: 10s
      retries: 5
  browser:
    image: 'coollabsio/openclaw-browser:latest'
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - CHROME_CLI=--remote-debugging-port=9222
    volumes:
      - 'browser-data:/config'
    shm_size: 2g
    healthcheck:
      test:
        - CMD-SHELL
        - "bash -c ':> /dev/tcp/127.0.0.1/9222' || exit 1"
      interval: 5s
      timeout: 5s
      retries: 10